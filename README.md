# Tennis Match Data Warehouse

## О проекте

Проект представляет собой полнофункциональное хранилище данных для анализа теннисных матчей. Система собирает, преобразует и структурирует данные из различных источников для обеспечения аналитиков качественной информацией о теннисных матчах, игроках и турнирах.

## Бизнес-задача

Создание единого источника качественных данных для комплексного анализа факторов, влияющих на результат теннисных матчей. Хранилище позволяет отвечать на ключевые бизнес-вопросы:
- Какие статистические показатели наиболее сильно коррелируют с победой?
- Как рейтинг игрока влияет на исход матча?
- Какие турниры наиболее предсказуемы с точки зрения ставок?
- Как меняется производительность игроков в зависимости от типа покрытия?

## Архитектура решения

### Многоуровневая архитектура данных

**STG (Staging) слой** - временное хранение сырых данных:
- `stg.srv_wf_settings` - сервисная таблица для управления ETL-процессами
- `stg.mongo_matches` - данные о матчах из MongoDB

**ODS (Operational Data Store) слой**:
- `ods.fct_matches` - широкая таблица фактов с детализированной информацией о матчах

**DDS (Data Delivery Service) слой** - структурированные данные по модели "снежинка":

**Измерения:**
- `dm_date` - временное измерение
- `dm_tour` - измерение турниров
- `dm_player` - измерение игроков
- `dm_player_rank` - измерение рейтингов игроков (SCD Type 2)

**Факты:**
- `fct_match_result` - результаты матчей (данные ДО и СРАЗУ ПОСЛЕ)
- `fct_match_performance` - детальная статистика производительности (ПОСЛЕ матча)

**CDM (Common Data Model) слой** - витрины данных для бизнес-анализа

## Ключевые особенности

### Инновационный подход к загрузке
Реализована стратегия "Разрешение измерений по ходу загрузки фактов" - сначала наполняются таблицы фактов, затем на их основе пополняются измерения, что позволяет работать с неполными исходными данными.

### Двойная модель фактов
- **Факты о матче**: коэффициенты (odds), статистика встреч (H2H) - известно ДО матча
- **Факты о результативности**: эйсы, подачи, ошибки - известно ПОСЛЕ матча

### Масштабируемая архитектура
- Сервисные таблицы для управления состоянием ETL-процессов

## Технологический стек

- **База данных**: PostgreSQL
- **Оркестрация**: Docker Compose
- **Источники данных**: MongoDB
- **Язык разработки**: Python

## Процесс обработки данных

### Ежедневный ETL-пайплайн

1. **Извлечение данных**: Автоматическое подключение к MongoDB и выгрузка новых данных
2. **Валидация**: Проверка схемы и типов данных с помощью Pydantic
3. **Загрузка в STG**: Сохранение сырых данных во временный слой
4. **Трансформация в ODS**: Парсинг и преобразование в широкую таблицу фактов
5. **Распределение по DDS**: Нормализация данных по модели "снежинка"
6. **Обогащение измерений**: Дозагрузка информации об игроках и турнирах
7. **Формирование витрин**: Создание аналитических представлений

## Структура проекта

```
scripts/
├── lib/
│   ├── pg_connect.py          # Подключение к PostgreSQL
│   ├── mongo_connect.py       # Подключение к MongoDB
│   └── init_schema.py         # Инициализация схемы
├── ddl/
│   ├── STG/                   # DDL для STG слоя
│   ├── 2_ODS_large_trans_tables.sql
│   └── 3_DDS_dm_fct_tables_create.sql
├── mongo_origin_stg_loader.py # Загрузка из MongoDB в STG
├── stg_ods_loader.py          # Загрузка из STG в ODS
└── parser/
    └── ods_safe_extract.py    # Парсер для безопасного извлечения
```

## Последовательность запуска

1. **Инициализация схемы**
   ```bash
   python scripts/lib/init_schema.py
   ```

2. **Первоначальная загрузка данных из MongoDB**
   ```bash
   python scripts/mongo_origin_stg_loader.py
   ```

3. **Трансформация и загрузка в ODS**
   ```bash
   python scripts/stg_ods_loader.py
   ```
3. **Трансформация и загрузка в DDS -> coming soon..**

## Мониторинг и управление

- Сервисная таблица `stg.srv_wf_settings` отслеживает прогресс загрузки
- Автоматическое управление курсорами для инкрементальной загрузки

## Перспективы развития

- Добавление новых источников данных (API)
- Реализация реального времени обновления данных
- Интеграция с ML-моделями для прогнозирования результатов
- Создание дашбордов для визуализации аналитики

Проект предоставляет надежную основу для построения сложных аналитических систем в области спортивной аналитики и беттинга.